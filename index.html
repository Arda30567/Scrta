
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voxel Architect v6.0 (Performance)</title>
    <style>
        body { 
            margin: 0; 
            background: #111; 
            overflow: hidden; 
            font-family: 'Segoe UI', monospace; 
        }

        /* Video artık tamamen net ve arkada */
        #input_video { 
            position: absolute; 
            width: 100vw; 
            height: 100vh; 
            object-fit: cover; 
            transform: scaleX(-1); /* Ayna efekti */
            z-index: 1; 
        }

        /* 3D Sahne videonun tam üzerinde */
        #three_canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100vw;
            height: 100vh;
            z-index: 5; 
            pointer-events: none; 
        }

        /* UI Katmanı */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .hud-panel { 
            position: absolute; 
            top: 20px; left: 20px; 
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid #00ff00;
            color: white;
            pointer-events: auto;
        }

        .btn {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px 15px;
            margin-top: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }
        .btn:hover { background: #444; }

        /* Başlatma Ekranı */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #000; z-index: 999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #00ff00;
        }
        #start-btn {
            font-size: 24px; padding: 20px 50px;
            background: #00ff00; color: #000; border: none;
            cursor: pointer; font-weight: bold; margin-top: 20px;
            border-radius: 5px;
        }

        #cursor-indicator {
            position: absolute;
            width: 20px; height: 20px;
            border: 2px solid yellow;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            display: none; /* JS ile yönetilecek */
            pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- Başlatma Ekranı -->
    <div id="loader">
        <h1>VOXEL ARCHITECT v6.0</h1>
        <p>Lütfen kameranızı açmaya hazır olun.</p>
        <button id="start-btn">SİSTEMİ BAŞLAT</button>
    </div>

    <!-- UI -->
    <div id="ui-layer">
        <div class="hud-panel">
            <h3>KONTROL PANELİ</h3>
            <div>FPS: <span id="fps">0</span></div>
            <div>Blok Sayısı: <span id="count">0</span></div>
            <div>Durum: <span id="status" style="color:yellow">Bekleniyor...</span></div>
            <br>
            <button class="btn" id="save-btn">Kaydet</button>
            <button class="btn" id="clear-btn" style="border-color:red; color:red;">Hepsini Sil</button>
        </div>
        <!-- 2D İmleç (İşaret parmağını takip eder) -->
        <div id="cursor-indicator"></div>
    </div>

    <video id="input_video" playsinline></video>
    <canvas id="three_canvas"></canvas>

    <!-- Kütüphaneler -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- TEMEL AYARLAR ---
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('three_canvas');
        const statusEl = document.getElementById('status');
        const fpsEl = document.getElementById('fps');
        const countEl = document.getElementById('count');
        const cursorEl = document.getElementById('cursor-indicator');
        
        // Three.js Değişkenleri
        let scene, camera, renderer;
        let voxelGroup;
        const voxels = []; // Blokları tutan dizi
        const voxelSize = 1.5; // Blok boyutu
        
        // Logic Değişkenleri
        let isPinching = false;
        let lastPinchTime = 0;
        const pinchCooldown = 500; // 500ms (Yarım saniye) bekleme süresi - spam engellemek için

        // --- BAŞLAT BUTONU ---
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('loader').style.display = 'none';
            initThree();
            initMediaPipe();
        });

        // --- THREE.JS BAŞLATMA (Hafif Versiyon) ---
        function initThree() {
            scene = new THREE.Scene();

            // Kamera ayarları: Z ekseninde geriye çekiyoruz
            // FOV 50, Aspect ratio pencereye göre
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 40; 

            renderer = new THREE.WebGLRenderer({
                canvas: canvasElement,
                alpha: true, // Arka plan şeffaf olsun ki videoyu görelim
                antialias: true // Kenar yumuşatma
            });
            renderer.setSize(window.innerWidth, window.innerHeight);

            // Işıklandırma (Basic Material kullanacağımız için çok şart değil ama bulunsun)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);

            // Tüm blokların ekleneceği grup
            voxelGroup = new THREE.Group();
            scene.add(voxelGroup);

            // Animasyon Döngüsü
            animate();
        }

        // --- MEDIAPIPE (EL TAKİBİ) ---
        function initMediaPipe() {
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 1, // Sadece tek el (performans ve karışıklığı önlemek için)
                modelComplexity: 0, // 0: Lite (Hızlı), 1: Full. Hız için 0 seçtim.
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720
            });
            cameraUtils.start();
        }

        // --- ANA MANTIK (ELİ AL, KOORDİNATA ÇEVİR, BLOK KOY) ---
        function onResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                statusEl.innerText = "El Bulunamadı";
                cursorEl.style.display = 'none';
                return;
            }

            const landmarks = results.multiHandLandmarks[0]; // İlk el
            
            // 1. İşaret Parmağı Ucu (8) ve Başparmak Ucu (4)
            const indexFinger = landmarks[8];
            const thumb = landmarks[4];

            // 2. İmleci Ekranda Göster (Sarı daire)
            // landmarks.x 0-1 arasındadır. Videoyu aynaladığımız için (1-x) yapıyoruz.
            const screenX = (1 - indexFinger.x) * window.innerWidth;
            const screenY = indexFinger.y * window.innerHeight;

            cursorEl.style.display = 'block';
            cursorEl.style.left = screenX + 'px';
            cursorEl.style.top = screenY + 'px';

            // 3. Çimdik Kontrolü (Mesafe Hesaplama)
            // Basit Pisagor: a^2 + b^2 = c^2
            const distance = Math.sqrt(
                Math.pow(indexFinger.x - thumb.x, 2) + 
                Math.pow(indexFinger.y - thumb.y, 2)
            );

            // Eşik değeri: 0.05 (Bu değer kamera yakınlığına göre değişebilir ama genelde iyidir)
            const isPinchingNow = distance < 0.05;

            if (isPinchingNow) {
                cursorEl.style.borderColor = "red"; // Çimdik yapınca kırmızı olsun
                cursorEl.style.backgroundColor = "rgba(255,0,0,0.5)";
                statusEl.innerText = "İNŞA EDİLİYOR";

                // Eğer yeni bir çimdikse ve bekleme süresi dolmuşsa
                const now = Date.now();
                if (!isPinching && (now - lastPinchTime > pinchCooldown)) {
                    placeBlockAtCursor(indexFinger.x, indexFinger.y);
                    lastPinchTime = now;
                    isPinching = true;
                }
            } else {
                cursorEl.style.borderColor = "yellow";
                cursorEl.style.backgroundColor = "transparent";
                statusEl.innerText = "Hareket Algılanıyor";
                isPinching = false;
            }
        }

        // --- BLOK KOYMA FONKSİYONU ---
        function placeBlockAtCursor(x, y) {
            // MediaPipe (0..1) koordinatlarını Three.js Dünya Koordinatlarına çevirmemiz lazım.
            // Kameramız Z=40'ta duruyor. Blokları Z=0 düzlemine koyacağız.
            
            // Bu matematik biraz karışık gelebilir ama temel olarak ekranın 2D noktasını 3D uzaya iz düşürüyoruz.
            const vec = new THREE.Vector3();
            const pos = new THREE.Vector3();

            // Ekran koordinatlarını -1 ile +1 arasına (NDC) çevir
            // X'i aynalamayı unutmuyoruz: (1-x)
            vec.set(
                ((1 - x) * 2) - 1,
                -(y * 2) + 1,
                0.5 
            );

            vec.unproject(camera);
            vec.sub(camera.position).normalize();

            // Kamera Z=40, Hedef Z=0. Mesafe = 40.
            const distanceToPlane = -camera.position.z / vec.z;
            pos.copy(camera.position).add(vec.multiplyScalar(distanceToPlane));

            // Grid'e oturtma (Snap to Grid)
            const snapX = Math.round(pos.x / voxelSize) * voxelSize;
            const snapY = Math.round(pos.y / voxelSize) * voxelSize;
            
            // Aynı yerde blok var mı kontrol et (Basitçe pozisyona bakıyoruz)
            const key = `${snapX},${snapY}`;
            const exists = voxels.some(v => v.position.x === snapX && v.position.y === snapY);

            if (!exists) {
                createVoxel(snapX, snapY, 0);
            }
        }

        function createVoxel(x, y, z) {
            // Neon tarzı bloklar
            // MeshBasicMaterial ışık hesaplamaz, bu yüzden ÇOK HIZLIDIR.
            const geometry = new THREE.BoxGeometry(voxelSize - 0.1, voxelSize - 0.1, voxelSize - 0.1);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ffcc, // Camgöbeği rengi
                wireframe: false,
                transparent: true,
                opacity: 0.8
            });
            
            const cube = new THREE.Mesh(geometry, material);
            cube.position.set(x, y, z);
            
            // Estetik için kenar çizgileri (Siyah)
            const edges = new THREE.EdgesGeometry(geometry);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 }));
            cube.add(line);

            voxelGroup.add(cube);
            voxels.push(cube);
            
            countEl.innerText = voxels.length;
        }

        // --- YARDIMCI FONKSİYONLAR ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            
            // FPS Sayacı
            fpsEl.innerText = Math.round(1 / clock.getDelta());

            // Sahneyi çiz
            renderer.render(scene, camera);
        }

        // Temizle Butonu
        document.getElementById('clear-btn').addEventListener('click', () => {
            voxels.forEach(v => voxelGroup.remove(v));
            voxels.length = 0;
            countEl.innerText = "0";
        });

        // Pencere Boyutlandırma
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>


